<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ASI — Worker Efficiency Dashboard</title>

  <style>
  :root{
    --accent:#E41E26;
    --burnt:#CC5500;
    --ok:#2ecc71;
    --warn:#ffd84d;
    --danger:#ff6b6b;
    --bg:#ffffff;
    --panel:#ffffff;
    --panel-2:#f6f7f9;
    --text:#111111;
    --muted:#5b6573;
    --border:#e5e8ef;
    --button:#f3f6fa;
  }

  /* Completely hide the Hide 0% rows toggle */
  #nonZeroToggle,
  #nonZeroToggle + span,
  label.toggle-inline {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
  }

  *{box-sizing:border-box;}
  html,body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:"Times New Roman", Times, serif;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .asi-logo{height:34px;width:auto;}
  .brand-text{display:flex;flex-direction:column;line-height:1.1;}
  .brand-text strong{font-size:20px;font-weight:800;color:var(--burnt);}
  .brand-text span{font-size:13px;color:var(--muted);}

/* LEFT pinned, RIGHT grouped */
.topbar-corner{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
  padding:10px 16px;
  border-bottom:3px solid var(--accent);
  background:var(--panel);
}

/* keep brand tight in the corner */
.brand-left{ flex:0 0 auto; }

/* LEFT column stack (logo row + button row under it) */
.topbar-left{
  display:flex;
  flex-direction:column;
  gap:8px; /* tighter */
}

/* Row B under the logo: ONLY Demo + How it works + freshness */
.topbar-left-actions{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}

/* Logo + date range on same row */
.brand-row{
  display:flex;
  align-items:flex-end;
  gap:16px;
  flex-wrap:wrap;
}

/* Keep date range compact when next to logo */
.date-inline{
  min-width:260px;
}

.date-inline .filter-label{
  font-size:11px;
}

/* Desktop: keep logo + date range on one line */
@media (min-width: 1100px){
  .brand-row{
    flex-wrap:nowrap;
  }
}

/* Chip style (Demo toggle + Last updated) */
.chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--button);
  font-size:13px;
  user-select:none;
}

.chip input{ margin:0; }

.chip-muted{
  cursor:default;
  opacity:.9;
}

/* everything else right-aligned */
.topbar-right{
flex:1 1 auto;
display:flex;
flex-direction:column;
align-items:flex-end;     /* <- right corner */
gap:10px;
min-width: 520px;         /* helps keep it on the right */
}

/* rows inside the right side */
.topbar-right-row{
display:flex;
flex-wrap:wrap;
justify-content:flex-end; /* <- right aligned wrap */
align-items:flex-end;
gap:10px 12px;
width:100%;
}

/* make filter blocks a bit tighter */
.filter-field.compact{ gap:3px; }
.filter-field.compact select,
.filter-field.compact input[type="date"]{
padding:6px 10px;
border-radius:10px;
}

/* Mobile: stack right side under brand */
@media (max-width: 900px){
.topbar-corner{
    flex-direction:column;
    align-items:flex-start;
}
.topbar-right{
    width:100%;
    min-width:0;
    align-items:flex-start;
}
.topbar-right-row{
    justify-content:flex-start;
}
}

  /* Filters - compact flex layout */
  .filters{
    display:flex;
    flex-wrap:wrap;
    align-items:flex-end;
    gap:8px 12px;
  }

  /* Each filter block */
  .filter-field{
    display:flex;
    flex-direction:column;
    gap:4px;
    font-size:12px;
  }

  .filter-label{
    font-size:12px;
    color:var(--muted);
  }

  /* Inline layout for date range inputs */
  .filter-inline{
    display:flex;
    align-items:center;
    gap:6px;
  }

  .filter-separator{
    font-size:12px;
    color:var(--muted);
  }

  /* Date range gets a bit more width */
  .filter-range{
    flex:1 1 260px;
    min-width:240px;
  }

  /* Button group on the right */
  .filter-actions{
    margin-left:auto;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }

  /* Small-screen behavior */
  @media (max-width: 900px){
  .topbar-corner{
    flex-direction:column;
    align-items:flex-start;
    gap:10px;
     }
    .filters{
      width:100%;
      flex-direction:column;
      align-items:flex-start;
    }
    .filter-actions{
      margin-left:0;
    }
  }

  input[type="date"],
  input[type="number"],
  select{
    background:#ffffff;
    border:1px solid var(--border);
    color:var(--text);
    padding:6px 10px;
    border-radius:10px;
    font-size:14px;
    outline:none;
  }

  input[type="date"]:focus,
  select:focus{
    border-color:#b9c6d8;
    box-shadow:0 0 0 2px rgba(204,85,0,.15);
  }
  .btn{
    background:var(--button);
    border:1px solid var(--border);
    color:#1f2a37;
    padding:7px 12px;
    border-radius:10px;
    font-size:14px;
    cursor:pointer;
  }
  .btn:hover{
    background:#e9edf3;
    border-color:#b9c6d8;
  }

  /* Non-zero toggle (now always on + hidden) */
  .toggle-inline{
    display:none; /* hide the label + checkbox */
  }
  .toggle-inline input{
    margin:0;
  }

  /* Layout */
  main{
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  /* Worker Snapshot Panel */
  .hidden {
    display: none !important;
  }

  .worker-snapshot {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 8px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
  }

  html[data-theme="dark"] .worker-snapshot {
    background: #1b1b1b;
    border-color: rgba(148, 163, 184, 0.4);
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.7);
  }

  .ws-header {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .ws-title-row {
    display: flex;
    align-items: baseline;
    gap: 8px;
    flex-wrap: wrap;
  }

  .ws-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 600;
    color: var(--muted);
  }

  .ws-name {
    font-size: 0.95rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(244, 244, 245, 0.9);
    color: var(--text);
  }

  html[data-theme="dark"] .ws-name {
    background: rgba(15, 23, 42, 0.9);
    color: #e5e7eb;
  }

  .ws-subtitle {
    font-size: 0.8rem;
    color: var(--muted);
  }

  .ws-stats {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 12px;
  }

  @media (max-width: 900px) {
    .ws-stats {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  .ws-stat {
    padding: 8px 10px;
    border-radius: 10px;
    background: var(--panel-2);
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  html[data-theme="dark"] .ws-stat {
    background: #161616;
  }

  .ws-stat-label {
    font-size: 0.75rem;
    color: var(--muted);
  }

  .ws-stat-value {
    font-size: 1.05rem;
    font-weight: 600;
  }

  .ws-eff-main {
    font-size: 1.15rem;
  }

  .ws-stat-sub {
    font-size: 0.75rem;
    color: var(--muted);
  }

  /* Efficiency color helpers */
  .eff-good {
    color: var(--ok);
    font-weight: 700;
  }
  .eff-warn {
    color: var(--warn);
    font-weight: 700;
  }
  .eff-bad {
    color: var(--danger);
    font-weight: 700;
  }

  /* Summary cards */
  .summary-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
  }

  .summary-card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 1px 3px rgba(16,24,40,.05);
  }
  .summary-label{
    font-size:12px;
    color:var(--muted);
  }
  .summary-value{
    font-size:20px;
    font-weight:800;
    margin-top:4px;
  }
  .summary-sub{
    font-size:11px;
    color:var(--muted);
    margin-top:2px;
  }

  /* Sections */
  .section{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 1px 3px rgba(16,24,40,.05);
    margin-top:4px;
  }
  .section-title{
    font-size:14px;
    font-weight:700;
    margin-bottom:6px;
    color:var(--burnt);
  }

  /* Chart sizing */
  .chart-wrapper{
    position:relative;
    width:100%;
    height:280px;
    margin-top:6px;
  }
  #workerBarChart,
  #workerTrendChart{
    width:100% !important;
    height:100% !important;
    display:block;
  }

  /* Table */
  .table-wrap{
    overflow-x:auto;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }

  th, td{
    padding:6px 8px;
    border-bottom:1px solid var(--border);
    white-space:nowrap;
    }

    /* Center numeric columns */
    td.num,
    th.num{
    text-align:center;
   }

/* Keep text columns left-aligned */
td.text,
th.text{
  text-align:left;
}

  th{
    background:var(--panel-2);
    font-weight:600;
    font-size:12px;
    color:var(--muted);
  }
  tbody tr:nth-child(even){
    background:var(--panel-2);
  }

  /* Footer */
  .footer{
    padding:10px 16px;
    text-align:center;
    font-size:12px;
    color:var(--muted);
    border-top:1px solid var(--border);
  }

  /* Dark mode */
  html[data-theme="dark"]{
    --bg:#121212;
    --panel:#1b1b1b;
    --panel-2:#161616;
    --text:#f1f1f1;
    --muted:#c0c6cf;
    --border:#2e2e2e;
    --button:#222428;
  }
  html[data-theme="dark"] body{background:var(--bg);}
  html[data-theme="dark"] header{background:#1b1b1b;}
  html[data-theme="dark"] .summary-card,
  html[data-theme="dark"] .section{box-shadow:none;}
  html[data-theme="dark"] input,
  html[data-theme="dark"] select{
    background:#101214;
    border-color:#3a3f46;
    color:#f1f1f1;
  }

/* Dark mode: force a visible calendar icon (reliable in Chrome/Edge) */
html[data-theme="dark"]{ color-scheme: dark; }

html[data-theme="dark"] input[type="date"]{
  color-scheme: dark;
}

/* Hide the native icon (but keep the clickable picker area) */
html[data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator{
  opacity: 0;
  cursor: pointer;
}

/* Draw our own white calendar icon */
html[data-theme="dark"] .date-inline input[type="date"]{
  padding-right: 36px; /* room for icon */
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'/%3E%3Cline x1='16' y1='2' x2='16' y2='6'/%3E%3Cline x1='8' y1='2' x2='8' y2='6'/%3E%3Cline x1='3' y1='10' x2='21' y2='10'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px 16px;
}

  html[data-theme="dark"] .btn{
    background:#2f343d;
    border-color:#4b5563;
    color:#f9fafb;
  }

  html[data-theme="dark"] .btn:hover{
    background:#4b5563;
    border-color:#6b7280;
  }

  </style>
</head>
<body>

<header class="topbar-corner">
  <!-- LEFT -->
  <div class="topbar-left">
    <div class="brand-row">
    <div class="brand brand-left">
        <img class="asi-logo" src="asi_logo.png" alt="ASI Logo">
        <div class="brand-text">
        <strong>Worker Efficiency Dashboard</strong>
        <span>American Specialties Inc. — Mirror Department</span>
    </div>
</div>

  <!-- Date range next to logo -->
  <div class="filter-field filter-range compact date-inline">
    <div class="filter-label">Date range</div>
    <div class="filter-inline">
      <input type="date" id="fromDate">
      <span class="filter-separator">to</span>
      <input type="date" id="toDate">
    </div>
  </div>
</div>


    <!-- Row B: ONLY Demo + How it works -->
    <div class="topbar-left-actions">
      <label class="chip">
        <input type="checkbox" id="demoModeToggle">
        Demo mode
      </label>

      <button class="btn" id="howItWorksBtn" type="button">How it works</button>

      <span class="chip chip-muted" id="freshnessTag">Last updated: —</span>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="topbar-right">
    <!-- Row 1: filters -->
    <div class="topbar-right-row">
      

      <label class="filter-field compact">
        <span class="filter-label">Role</span>
        <select id="roleFilter">
          <option value="all">All roles</option>
          <option value="assembler">Assemblers</option>
          <option value="packer">Packing</option>
        </select>
      </label>

      <label class="filter-field compact">
        <span class="filter-label">Mirror type</span>
        <select id="mirrorTypeFilter">
          <option value="all">All</option>
          <option value="0620">0620</option>
          <option value="0600">0600</option>
        </select>
      </label>

      <label class="filter-field compact">
        <span class="filter-label">Category</span>
        <select id="mirrorClassFilter">
          <option value="all">All</option>
          <option value="standard">Standard</option>
          <option value="special">Special</option>
        </select>
      </label>

      <label class="filter-field compact">
        <span class="filter-label">Baseline</span>
        <select id="baselineMode">
          <option value="75" selected>75% engineering standard</option>
          <option value="100">100% engineering standard</option>
        </select>
      </label>

      <label class="filter-field compact">
        <span class="filter-label">Worker / Station</span>
        <select id="workerFilter">
          <option value="all">All</option>
        </select>
      </label>
    </div>

    <!-- Row 2: actions on the right -->
    <div class="topbar-right-row">
      <button class="btn" id="quick7" type="button">Last 7 days</button>
      <button class="btn" id="refreshBtn" type="button">Refresh</button>
      <button class="btn" id="openUploaderBtn" type="button">Worker Hourly Logger</button>
      <button class="btn" id="themeToggle" type="button">Dark mode</button>
      <button class="btn" id="exportCsvBtn" type="button">Export CSV</button>
      <button class="btn" id="exportDailyReportBtn" type="button">Export Daily Report (PDF)</button>
      <button class="btn" id="exportMirrorAssemblyBtn" type="button">Export Mirror Assembly (PDF)</button>
      <button class="btn" id="exportPdfBtn" type="button">Export PDF (1:1)</button>
    </div>
  </div>
</header>


<main>

  <!-- Worker Snapshot Panel -->
  <div id="workerSnapshot" class="worker-snapshot hidden">
    <div class="ws-header">
      <div class="ws-title-row">
        <span class="ws-label">Worker snapshot</span>
        <span id="wsWorkerName" class="ws-name">—</span>
      </div>
      <div id="wsDateRange" class="ws-subtitle">Last 7 days</div>
    </div>

    <div class="ws-stats">
      <div class="ws-stat">
        <div class="ws-stat-label">Today’s efficiency</div>
        <div id="wsTodayEff" class="ws-stat-value ws-eff-main">—</div>
        <div id="wsTodayUnits" class="ws-stat-sub">— units today</div>
      </div>

      <div class="ws-stat">
        <div class="ws-stat-label">Range average</div>
        <div id="wsWeeklyAvg" class="ws-stat-value">—</div>
        <div id="wsWeeklyUnits" class="ws-stat-sub">— total units</div>
      </div>

      <div class="ws-stat">
        <div class="ws-stat-label">Consistency</div>
        <div id="wsBestDayEff" class="ws-stat-value">—</div>
        <div id="wsBestDayLabel" class="ws-stat-sub">—</div>
      </div>

      <div class="ws-stat">
        <div class="ws-stat-label">On-target days</div>
        <div id="wsWorstDayEff" class="ws-stat-value">—</div>
        <div id="wsWorstDayLabel" class="ws-stat-sub">—</div>
      </div>

      <!-- Top mirror type -->
      <div class="ws-stat">
        <div class="ws-stat-label">Top mirror type</div>
        <div id="wsTopTypeValue" class="ws-stat-value">—</div>
        <div id="wsTopTypeLabel" class="ws-stat-sub">—</div>
      </div>

      <!-- Top mirror category -->
      <div class="ws-stat">
        <div class="ws-stat-label">Top mirror category</div>
        <div id="wsTopClassValue" class="ws-stat-value">—</div>
        <div id="wsTopClassLabel" class="ws-stat-sub">—</div>
      </div>
    </div>
  </div>

  <section class="summary-grid" id="summaryCards">
    <!-- Filled by JS -->
  </section>

  <section class="section">
    <div class="section-title" id="barTitle">
      Average efficiency by worker / station (selected filters)
    </div>
    <div class="chart-wrapper">
      <canvas id="workerBarChart"></canvas>
    </div>
  </section>

  <section class="section">
    <div class="section-title" id="trendTitle">
      Daily efficiency trend (select a worker / station)
    </div>
    <div class="chart-wrapper">
      <canvas id="workerTrendChart"></canvas>
    </div>
  </section>

  <section class="section">
    <div class="section-title" id="leaderTitle">
      Weekly leaderboard (latest week in range)
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Week</th>
            <th>Worker / Station</th>
            <th style="text-align:right;">Avg efficiency %</th>
            <th style="text-align:right;">Days counted</th>
          </tr>
        </thead>
        <tbody id="leaderBody">
          <!-- leaderboard rows -->
        </tbody>
      </table>
    </div>
  </section>

  <section class="section">
    <div class="section-title">Detail by day &amp; worker / station</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Role</th>
            <th>Worker / Station</th>
            <th>Part #</th> <!-- NEW -->
            <th>Mirror type</th>
            <th>Category</th>
            <th style="text-align:right;">Daily total</th>
            <th style="text-align:right;">Target</th>
            <th style="text-align:right;">Efficiency %</th>
          </tr>
        </thead>
        <tbody id="detailBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>
  </section>
</main>

<div class="footer">
  Data source: Supabase table <code>worker_daily_log</code> • Exported from Daily_Log (Excel).
</div>

<!-- Supabase & Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- NEW: jsPDF for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
// ---------- BASIC HELPERS ----------
function $(s){ return document.querySelector(s); }
function uniq(arr){ return Array.from(new Set(arr)); }

function round2(v){
  if (v == null || isNaN(v)) return "—";
  return Number(v).toFixed(2);
}

// ---------- SUPABASE CLIENT ----------
const SUPABASE_URL = 'https://coxxavwtkwbqotunldqv.supabase.co';
const SUPABASE_ANON_KEY =
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNveHhhdnd0a3dicW90dW5sZHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwOTY0MTIsImV4cCI6MjA3OTY3MjQxMn0.21Rx_Sn2tkbR5C_itOmiph9c1OpqXC2H6AeR-AHL4Jo';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ---------- REALTIME AUTO-REFRESH ----------
let rtChannel = null;
let refreshTimer = null;

function scheduleLiveRefresh(reason = "live") {
  if (demoMode) return;            // don't live-refresh demo mode
  if (refreshTimer) clearTimeout(refreshTimer);

  // debounce (hourly logger edits can fire multiple events quickly)
  refreshTimer = setTimeout(() => {
    console.log("[Realtime] refreshing due to:", reason);
    loadAndRender();
  }, 450);
}

function startRealtime() {
  // safety: avoid double-subscribing
  if (rtChannel) {
    try { supabase.removeChannel(rtChannel); } catch(e) {}
    rtChannel = null;
  }

  rtChannel = supabase
    .channel("we-live-worker-daily-log")
    .on(
      "postgres_changes",
      { event: "*", schema: "public", table: "worker_daily_log" },
      (payload) => {
        // Only refresh if the changed row is within our selected date range
        const from = $("#fromDate")?.value;
        const to   = $("#toDate")?.value;

        const d = (payload.new?.log_date || payload.old?.log_date || "").slice(0, 10);
        if (!d) return;

        const inRange =
          (!from || d >= from) &&
          (!to   || d <= to);

        if (inRange) scheduleLiveRefresh(payload.eventType || "change");
      }
    )
    .subscribe((status) => {
      console.log("[Realtime] status:", status);
    });
}

// ---------- ADMIN UPLOADER URL ----------
const HOURLY_LOG_UPLOADER_URL =
  "https://acuaping2023.github.io/asi-mes-dashboards/ADMIN_worker_hourly_logger_v1.html";

// ---------- DATE HELPERS ----------
function todayIso(){
  return new Date().toISOString().slice(0,10);
}
function isoNDaysAgo(n){
  const d = new Date();
  d.setDate(d.getDate() - n);
  return d.toISOString().slice(0,10);
}

// ISO week key helper: YYYY-Www
function getWeekKey(dateStr){
  if(!dateStr) return null;
  const d = new Date(dateStr + "T00:00:00Z");
  if(isNaN(d)) return null;

  const day = d.getUTCDay() || 7; // 1..7
  d.setUTCDate(d.getUTCDate() + 4 - day);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  const year = d.getUTCFullYear();
  return `${year}-W${String(weekNo).padStart(2,"0")}`;
}

// ---------- STATE ----------
let lastRows = [];

// ---------- DEMO MODE + FRESHNESS ----------
const DEMO_KEY = "WE_DEMO_MODE_v1";

let demoMode = false;

function nowStamp(){
  return new Date().toLocaleString();
}

function setFreshness(text){
  const el = document.getElementById("freshnessTag");
  if(el) el.textContent = text;
}

// Ensure the view always returns what we expect
const REQUIRED_VIEW_FIELDS = [
  "log_date",
  "worker_name",
  "role",
  "mirror_type",
  "mirror_class",
  "part_number",
  "daily_total",
  "daily_efficiency_pct_75",
  "daily_efficiency_pct_100",
  "target_75",
  "target_100"
];

function validateViewShape(rows){
  if(!rows || !rows.length) return { ok:true, missing:[] };
  const sample = rows[0] || {};
  const missing = REQUIRED_VIEW_FIELDS.filter(k => !(k in sample));
  return { ok: missing.length === 0, missing };
}

// Simple, safe demo dataset (portfolio-friendly)
function getDemoRows(){
  const today = new Date();
  const iso = (d) => d.toISOString().slice(0,10);
  const days = [];
  for(let i=13;i>=0;i--){
    const d = new Date(today);
    d.setDate(d.getDate()-i);
    days.push(iso(d));
  }

  const workers = [
    { name:"Station 1 — Demo", role:"assembler" },
    { name:"Station 2 — Demo", role:"assembler" },
    { name:"Packer A — Demo", role:"packer" }
  ];

  const out = [];
  days.forEach((day, idx) => {
    workers.forEach((w, wi) => {
      const type = wi === 2 ? "0600" : "0620";
      const cls  = (idx % 3 === 0) ? "special" : "standard";
      const daily = 6 + ((idx + wi) % 6); // 6..11
      const t75 = w.role === "packer" ? 10 : 8;
      const t100 = w.role === "packer" ? 14 : 11;

      // Some intentional missing standards to prove guardrails:
      const missingStandard = (idx % 10 === 0 && wi === 1);

      const eff75  = missingStandard ? null : (daily / t75) * 100;
      const eff100 = missingStandard ? null : (daily / t100) * 100;

      out.push({
        log_date: day,
        worker_name: w.name,
        role: w.role,
        mirror_type: type,
        mirror_class: cls,
        part_number: type === "0620" ? "0620-2436" : "0600-3040",
        daily_total: daily,
        target_75: missingStandard ? null : t75,
        target_100: missingStandard ? null : t100,
        daily_efficiency_pct_75: eff75,
        daily_efficiency_pct_100: eff100
      });
    });
  });

  return out;
}

let barChartInstance   = null;
let trendChartInstance = null;

// ---------- WORKER SNAPSHOT PANEL HELPERS ----------
const workerSnapshotEl  = document.getElementById("workerSnapshot");
const wsWorkerNameEl    = document.getElementById("wsWorkerName");
const wsDateRangeEl     = document.getElementById("wsDateRange");
const wsTodayEffEl      = document.getElementById("wsTodayEff");
const wsTodayUnitsEl    = document.getElementById("wsTodayUnits");
const wsWeeklyAvgEl     = document.getElementById("wsWeeklyAvg");
const wsWeeklyUnitsEl   = document.getElementById("wsWeeklyUnits");
const wsBestDayEffEl    = document.getElementById("wsBestDayEff");
const wsBestDayLabelEl  = document.getElementById("wsBestDayLabel");
const wsWorstDayEffEl   = document.getElementById("wsWorstDayEff");
const wsWorstDayLabelEl = document.getElementById("wsWorstDayLabel");
const wsTopTypeValueEl  = document.getElementById("wsTopTypeValue");
const wsTopTypeLabelEl  = document.getElementById("wsTopTypeLabel");
const wsTopClassValueEl = document.getElementById("wsTopClassValue");
const wsTopClassLabelEl = document.getElementById("wsTopClassLabel");

function formatPercent(value){
  if(value == null || isNaN(value)) return "—";
  return value.toFixed(0) + "%";
}

function formatUnits(value){
  if(value == null || isNaN(value)) return "—";
  return value.toFixed(0).toString();
}

function updateWorkerSnapshot(workerName, stats){
  if(!workerSnapshotEl) return;

  if(!workerName || !stats){
    workerSnapshotEl.classList.add("hidden");
    return;
  }

  workerSnapshotEl.classList.remove("hidden");

  wsWorkerNameEl.textContent = workerName;

  // Range label + trend
  if (stats.trendLabel && stats.trendLabel !== "Trend: —"){
    wsDateRangeEl.textContent =
      (stats.dateRangeLabel || "Selected range") + " — " + stats.trendLabel;
  } else {
    wsDateRangeEl.textContent = stats.dateRangeLabel || "Selected range";
  }

  // Today
  wsTodayEffEl.textContent   = formatPercent(stats.todayEfficiency);
  wsTodayUnitsEl.textContent = `${formatUnits(stats.todayUnits)} units today`;
  applyEfficiencyClassToElement(wsTodayEffEl, stats.todayEfficiency);

    // Range average + department comparison
  wsWeeklyAvgEl.textContent = formatPercent(stats.weeklyAverageEfficiency);
  applyEfficiencyClassToElement(wsWeeklyAvgEl, stats.weeklyAverageEfficiency);

  let unitsText = `${formatUnits(stats.weeklyTotalUnits)} total units`;

  if (stats.deptAvgEff != null) {
    const deptVal = stats.deptAvgEff.toFixed(1);
    const delta = stats.deltaFromDept ?? 0;
    const absDelta = Math.abs(delta);
    let compareText = "";

    if (absDelta < 0.5) {
      compareText = `Dept avg this range: ${deptVal}% (about at dept avg)`;
    } else {
      const sign = delta > 0 ? "+" : "−";
      compareText = `Dept avg this range: ${deptVal}% (${sign}${absDelta.toFixed(1)} pts vs dept)`;
    }

    unitsText += ` • ${compareText}`;
  }

  wsWeeklyUnitsEl.textContent = unitsText;

  // Consistency
  wsBestDayEffEl.textContent =
    stats.consistencyLabel || "—";
  wsBestDayLabelEl.textContent =
    stats.consistencyStd != null
      ? `Std dev: ${stats.consistencyStd.toFixed(1)} pts`
      : "—";

  // On-target days
  if (stats.onTargetPct != null){
    wsWorstDayEffEl.textContent = `${stats.onTargetPct.toFixed(0)}%`;
    wsWorstDayLabelEl.textContent =
      `${stats.onTargetDays} of ${stats.daysCount} days ≥ ${EFF_WARN_MIN}%`;
  } else {
    wsWorstDayEffEl.textContent = "—";
    wsWorstDayLabelEl.textContent = "—";
  }

  // Top mirror type
  if (stats.topType){
    wsTopTypeValueEl.textContent = stats.topType;
    if (stats.topTypeShare != null){
      wsTopTypeLabelEl.textContent =
        `${stats.topTypeUnits.toLocaleString()} units (${stats.topTypeShare.toFixed(0)}% of range)`;
    } else {
      wsTopTypeLabelEl.textContent =
        `${stats.topTypeUnits.toLocaleString()} units`;
    }
  } else {
    wsTopTypeValueEl.textContent = "—";
    wsTopTypeLabelEl.textContent = "—";
  }

  // Top mirror category
  if (stats.topClass){
    wsTopClassValueEl.textContent = stats.topClass;
    if (stats.topClassShare != null){
      wsTopClassLabelEl.textContent =
        `${stats.topClassUnits.toLocaleString()} units (${stats.topClassShare.toFixed(0)}% of range)`;
    } else {
      wsTopClassLabelEl.textContent =
        `${stats.topClassUnits.toLocaleString()} units`;
    }
  } else {
    wsTopClassValueEl.textContent = "—";
    wsTopClassLabelEl.textContent = "—";
  }
}

function computeWorkerSnapshotStats(rows, deptRows){
  if(!rows || !rows.length) return null;

  // sort by date
  const sorted = [...rows].sort((a,b) =>
    (a.log_date > b.log_date) ? 1 : (a.log_date < b.log_date ? -1 : 0)
  );

  // Build daily weighted series for worker
  const series = buildDailyWeightedSeries(sorted).filter(p => p.eff != null && !isNaN(p.eff));
  const lastDay = series.length ? series[series.length - 1].date : (sorted[sorted.length-1].log_date || "").slice(0,10);

  // Today (latest day) weighted
  const todayRows = sorted.filter(r => (r.log_date || "").slice(0,10) === lastDay);
  const todaySum = sumActualTarget(todayRows);
  const todayEff = todaySum.target > 0 ? (todaySum.actual / todaySum.target) * 100 : null;

  // Range weighted
  const rangeSum = sumActualTarget(sorted);
  const weeklyAvg = rangeSum.target > 0 ? (rangeSum.actual / rangeSum.target) * 100 : null;

  // ---------- Department average (same filters, all workers) weighted ----------
  let deptAvgEff = null;
  let deltaFromDept = null;

  if (deptRows && deptRows.length) {
    const deptSum = sumActualTarget(deptRows);
    if (deptSum.target > 0) deptAvgEff = (deptSum.actual / deptSum.target) * 100;
    if (weeklyAvg != null && deptAvgEff != null) deltaFromDept = weeklyAvg - deptAvgEff;
  }

  // ---------- Consistency (std dev of daily weighted efficiencies) ----------
  let consistencyStd = null;
  let consistencyLabel = null;

  const effValues = series.map(p => p.eff);
  const daysCount = effValues.length;

  if (effValues.length > 1 && weeklyAvg != null){
    const mean = weeklyAvg;
    const variance = effValues.reduce((t,v) => t + Math.pow(v - mean, 2), 0) / (effValues.length - 1);
    consistencyStd = Math.sqrt(variance);

    if (consistencyStd < 3){
      consistencyLabel = "Highly consistent";
    } else if (consistencyStd < 8){
      consistencyLabel = "Moderately consistent";
    } else {
      consistencyLabel = "Highly variable";
    }
  }

  // ---------- On-target days (daily weighted ≥ 75%) ----------
  let onTargetDays = 0;
  effValues.forEach(e => { if (e >= EFF_WARN_MIN) onTargetDays++; });
  const onTargetPct = daysCount ? (onTargetDays / daysCount) * 100 : null;

  // ---------- Trend (early vs late avg using daily weighted series) ----------
  let trendLabel = "Trend: —";
  if (series.length >= 2){
    const n = series.length;
    const split = Math.floor(n / 2) || 1;

    const early = series.slice(0, split);
    const late  = series.slice(n - split);

    const earlyAvg = early.reduce((t,p) => t + p.eff, 0) / early.length;
    const lateAvg  = late.reduce((t,p) => t + p.eff, 0) / late.length;

    const diff = lateAvg - earlyAvg;
    const absDiff = Math.abs(diff);

    let descriptor = "stable";
    if (absDiff < 3){
      descriptor = "stable";
    } else if (absDiff < 7){
      descriptor = diff > 0 ? "slightly upward" : "slightly downward";
    } else {
      descriptor = diff > 0 ? "significantly upward" : "significantly downward";
    }

    trendLabel = descriptor === "stable" ? "Trend: stable" : `Trend: ${descriptor}`;
  }

  // ---------- Mirror-type/category breakdown by units (unchanged) ----------
  let totalUnits = 0;
  const typeUnits  = {};
  const classUnits = {};

  sorted.forEach(r => {
    const u = Number(r.daily_total) || 0;
    const type = (r.mirror_type  || "Unknown").toString();
    const cls  = (r.mirror_class || "Unknown").toString();
    totalUnits += u;

    typeUnits[type]  = (typeUnits[type]  || 0) + u;
    classUnits[cls]  = (classUnits[cls]  || 0) + u;
  });

  let topType = null, topUnits = 0;
  Object.keys(typeUnits).forEach(type => {
    if (typeUnits[type] > topUnits){ topUnits = typeUnits[type]; topType = type; }
  });

  let topClass = null, topClassUnits = 0;
  Object.keys(classUnits).forEach(cls => {
    if (classUnits[cls] > topClassUnits){ topClassUnits = classUnits[cls]; topClass = cls; }
  });

  const topTypeShare = (topType && totalUnits > 0) ? (typeUnits[topType] / totalUnits) * 100 : null;
  const topClassShare = (topClass && totalUnits > 0) ? (classUnits[topClass] / totalUnits) * 100 : null;

  const from = document.getElementById("fromDate")?.value;
  const to   = document.getElementById("toDate")?.value;
  let rangeLabel = "Selected range";
  if(from && to) rangeLabel = `${from} to ${to}`;

  return {
    todayEfficiency: todayEff,
    todayUnits: todaySum.actual,
    weeklyAverageEfficiency: weeklyAvg,
    weeklyTotalUnits: totalUnits,

    consistencyStd,
    consistencyLabel,
    daysCount,
    onTargetDays,
    onTargetPct,
    trendLabel,

    topType,
    topTypeShare,
    topTypeUnits: topUnits,

    topClass,
    topClassShare,
    topClassUnits: topClassUnits,

    dateRangeLabel: rangeLabel,

    deptAvgEff,
    deltaFromDept
  };
}

// ---------- MAIN LOAD ----------
document.addEventListener("DOMContentLoaded", () => {

  // THEME INIT
  const savedTheme = localStorage.getItem("asiTheme") || "light";
  document.documentElement.setAttribute(
    "data-theme",
    savedTheme === "dark" ? "dark" : "light"
  );

  const themeToggle = $("#themeToggle");
  function updateThemeButtonLabel(){
    const isDark = document.documentElement.getAttribute("data-theme") === "dark";
    if (themeToggle){
      themeToggle.textContent = isDark ? "Light mode" : "Dark mode";
    }
  }
  updateThemeButtonLabel();

  if (themeToggle){
    themeToggle.addEventListener("click", () => {
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      const next = isDark ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next);
      localStorage.setItem("asiTheme", next);
      updateThemeButtonLabel();

      if (lastRows && lastRows.length){
        renderAll(lastRows);
      }
    });
  }

  // DEFAULT DATE RANGE
  $("#toDate").value   = todayIso();
  $("#fromDate").value = isoNDaysAgo(6);

  // Always hide 0% rows
  const nz = $("#nonZeroToggle");
  if (nz) {
    nz.checked = true;
    nz.addEventListener("change", () => renderAll(lastRows));
  }

  const baselineSel = $("#baselineMode");
  if (baselineSel){
    baselineSel.addEventListener("change", () => renderAll(lastRows));
  }


  // HEADER BUTTONS
  const quick7Btn = $("#quick7");
  if (quick7Btn){
    quick7Btn.addEventListener("click", () => {
      $("#toDate").value   = todayIso();
      $("#fromDate").value = isoNDaysAgo(6);
      loadAndRender();
    });
  }

  const refreshBtn = $("#refreshBtn");
  if (refreshBtn){
    refreshBtn.addEventListener("click", loadAndRender);
  }

  // CSV export button
  const exportCsvBtn = document.getElementById("exportCsvBtn");
  if (exportCsvBtn) {
    exportCsvBtn.addEventListener("click", () => {
      const { rows } = getCurrentFilteredRows();
      exportRowsToCSV(rows);
    });
  }

  // PDF export button (1:1)
  const exportPdfBtn = document.getElementById("exportPdfBtn");
  if (exportPdfBtn) {
    exportPdfBtn.addEventListener("click", () => {
      exportWorkerPdf();
    });
  }

  // Mirror Assembly (PDF)
    const exportMirrorAssemblyBtn = document.getElementById("exportMirrorAssemblyBtn");
    if (exportMirrorAssemblyBtn) {
        exportMirrorAssemblyBtn.addEventListener("click", () => {
            exportMirrorAssemblyPdf_FirstShiftOnly();
        });
    }
    
    // ---------- MIRROR ASSEMBLY (PDF) — 1st SHIFT ONLY (NO 2nd SHIFT) ----------
    function exportMirrorAssemblyPdf_FirstShiftOnly(){
    // Use SAME filters as dashboard (role/type/category + hide 0% rows)
    const base0 = applyBaseFilters(lastRows || []);
    const base  = applyNonZeroFilter(base0);

    if(!base.length){
        alert("No data available for the selected filters/date range.");
        return;
    }

    // Build date list within current dashboard range
    const from = $("#fromDate")?.value || null;
    const to   = $("#toDate")?.value || null;

    const dates = Array.from(new Set(base.map(r => (r.log_date || "").slice(0,10))))
        .filter(d => d && (!from || d >= from) && (!to || d <= to))
        .sort();

    if(!dates.length){
        alert("No rows found inside the selected date range.");
        return;
    }

    // Sum helper for type+date
    function sumTypeOnDate(date, mirrorType){
        const rows = base.filter(r =>
        (r.log_date || "").slice(0,10) === date &&
        (r.mirror_type || "") === mirrorType
        );

        const actual = rows.reduce((t,r)=> t + (Number(r.daily_total) || 0), 0);

        // expected uses baseline-aware target (your getTarget() already handles 75/100 + missing std)
        const expected = rows.reduce((t,r)=> t + (Number(getTarget(r)) || 0), 0);

        return { actual, expected };
    }

    // Totals
    let t0600A = 0, t0600E = 0, t0620A = 0, t0620E = 0;

    // Table body: Date | 0600 A | 0600 E | 0620 A | 0620 E
    const body = dates.map(date => {
        const s0600 = sumTypeOnDate(date, "0600");
        const s0620 = sumTypeOnDate(date, "0620");

        t0600A += s0600.actual; t0600E += s0600.expected;
        t0620A += s0620.actual; t0620E += s0620.expected;

        return [
            date,
            round2(s0600.actual || 0),
            round2(s0600.expected || 0),
            round2(s0620.actual || 0),
            round2(s0620.expected || 0)
        ];
    });

    // Efficiency (shift = overall for now)
    const totalActual = t0600A + t0620A;
    const totalExpected = t0600E + t0620E;
    const eff = totalExpected > 0 ? (totalActual / totalExpected) * 100 : 0;

    // ---------- PDF ----------
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:"landscape", unit:"pt", format:"a4" });

    doc.setFont("times","bold");
    doc.setFontSize(16);
    doc.text("Mirror Assembly", 40, 40);

    doc.setFont("times","normal");
    doc.setFontSize(11);

    const baselineMode = getBaselineMode(); // "75" or "100"
    doc.text(
        `Date range: ${dates[0]} to ${dates[dates.length-1]}   •   Baseline: ${baselineMode === "100" ? "100%" : "75%"} engineering standard`,
        40,
        60
    );

    // Main table header (matches your sheet feel, but only 1st shift)
    doc.autoTable({
        startY: 80,
        head: [[
        "Date",
        "0600 Actual", "0600 Expected",
        "0620 Actual", "0620 Expected"
        ]],
        body,
        styles: { font:"times", fontSize: 9, cellPadding: 4 },
        headStyles: { fontStyle:"bold" },
        margin: { left: 40, right: 40 },
        didParseCell: (data) => {
        // Color Actual cols light green, Expected cols light blue
        if (data.section === "body" && data.column.index > 0) {
            const isActual = (data.column.index === 1 || data.column.index === 3);
            data.cell.styles.fillColor = isActual ? [232,245,233] : [227,242,253];
            data.cell.styles.halign = "right";
        }
        if (data.section === "body" && data.column.index === 0) {
            data.cell.styles.halign = "center";
        }
        }
    });

    // Subtotal row
    const y1 = doc.lastAutoTable.finalY + 14;

    doc.autoTable({
        startY: y1,
        head: [[ "", "0600 Actual", "0600 Expected", "0620 Actual", "0620 Expected" ]],
        body: [[
            "Sub Total (Shift)",
            round2(t0600A), round2(t0600E),
            round2(t0620A), round2(t0620E)
        ]],
        styles: { font:"times", fontSize: 9, cellPadding: 4 },
        headStyles: { fontStyle:"bold" },
        margin: { left: 40, right: 40 },
        didParseCell: (data) => {
        if (data.section === "body" && data.column.index > 0) data.cell.styles.halign = "center";
        if (data.section === "body" && data.column.index === 0) data.cell.styles.fontStyle = "bold";
        }
    });

    // Efficiency blocks
    let y = doc.lastAutoTable.finalY + 22;
    doc.setFont("times","bold");
    doc.setFontSize(11);
    doc.text("Efficiency %", 40, y);
    doc.setFont("times","normal");
    doc.text(`${eff.toFixed(2)}%`, 140, y);

    y += 22;
    doc.setFont("times","bold");
    doc.text("Overall Efficiency (%)", 40, y);
    doc.setFont("times","normal");
    doc.text(`${eff.toFixed(2)}%`, 220, y);

    const fname = `mirror_assembly_${dates[0]}_to_${dates[dates.length-1]}_baseline_${baselineMode}.pdf`;
    doc.save(fname);
    }


  // ---------- DAILY PRODUCTION REPORT (PDF) ----------
function safeNum(n){
  const v = Number(n);
  return isNaN(v) ? 0 : v;
}

function groupSum(rows, keyFn){
  const out = {};
  (rows || []).forEach(r => {
    const k = (keyFn(r) ?? "Unknown").toString();
    if(!out[k]) out[k] = { units:0, target:0, rows:0 };
    out[k].units += safeNum(r.daily_total);
    out[k].target += safeNum(getTarget(r)); // baseline-aware target (75/100)
    out[k].rows += 1;
  });
  return out;
}

function calcOverallEff(rows){
  const units = (rows || []).reduce((t,r)=> t + safeNum(r.daily_total), 0);
  const target = (rows || []).reduce((t,r)=> t + safeNum(getTarget(r)), 0);
  const eff = target > 0 ? (units / target) * 100 : null;
  return { units, target, eff };
}

async function exportDailyProductionReportPdf(){
  // Use SAME filters as the dashboard, then lock to a single day (latest day in range = toDate)
  const to = $("#toDate")?.value || todayIso();
  const from = $("#fromDate")?.value || null;

  // Base rows reflect Role/MirrorType/Category + NonZero filter
  const base0 = applyBaseFilters(lastRows || []);
  const base  = applyNonZeroFilter(base0);

  // Lock to daily view: choose "toDate" day (common “daily production” behavior)
  const dayRows = base.filter(r => (r.log_date || "").slice(0,10) === to);

  if(!dayRows.length){
    alert(`No data found for ${to} with the current filters.`);
    return;
  }

  const baselineMode = getBaselineMode(); // "75" or "100"

  // Headline totals (THIS is the exec-style efficiency)
  const totals = calcOverallEff(dayRows);

  // Breakdowns
  const byRole  = groupSum(dayRows, r => (r.role || "Unknown").toLowerCase());
  const byType  = groupSum(dayRows, r => r.mirror_type || "Unknown");
  const byClass = groupSum(dayRows, r => (r.mirror_class || "Unknown").toLowerCase());

  // Top / bottom performers for the day (eff = sum(units)/sum(target) PER worker)
  const byWorker = {};
  dayRows.forEach(r => {
    const name = (r.worker_name || "Unknown").toString();
    if(!byWorker[name]) byWorker[name] = { units:0, target:0, rows:0, missingStd:0 };
    byWorker[name].units += safeNum(r.daily_total);
    const tgt = getTarget(r);
    if(tgt == null) byWorker[name].missingStd += 1;
    byWorker[name].target += safeNum(tgt);
    byWorker[name].rows += 1;
  });

  const workerRank = Object.keys(byWorker).map(name => {
    const u = byWorker[name].units;
    const t = byWorker[name].target;
    const eff = t > 0 ? (u / t) * 100 : null;
    return {
      name,
      units: u,
      target: t,
      eff,
      missingStd: byWorker[name].missingStd
    };
  }).sort((a,b) => {
    // null eff to bottom
    if(a.eff == null && b.eff == null) return 0;
    if(a.eff == null) return 1;
    if(b.eff == null) return -1;
    return b.eff - a.eff;
  });

  const top5 = workerRank.slice(0,5);
  const bottom5 = workerRank
    .filter(x => x.eff != null)
    .slice(-5)
    .sort((a,b)=> a.eff - b.eff);

  const missingStdWorkers = workerRank
    .filter(x => x.missingStd > 0)
    .sort((a,b)=> b.missingStd - a.missingStd)
    .slice(0,10);

  // ---------- Build PDF ----------
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:"portrait", unit:"pt", format:"a4" });

  // Header
  doc.setFont("times","bold");
  doc.setFontSize(16);
  doc.text("Daily Production Report — Mirror Department", 40, 42);

  doc.setFont("times","normal");
  doc.setFontSize(11);
  doc.text(`Report date: ${to}`, 40, 64);

  if(from && to){
    doc.text(`Dashboard range: ${from} to ${to} (report locks to ${to})`, 40, 80);
  }

  doc.text(
    `Baseline: ${baselineMode === "100" ? "100% engineering standard" : "75% engineering standard"}`,
    40,
    96
  );

  // Filters summary (what higher-ups will ask)
  const roleVal = ($("#roleFilter")?.value || "all");
  const typeVal = ($("#mirrorTypeFilter")?.value || "all");
  const clsVal  = ($("#mirrorClassFilter")?.value || "all");
  doc.text(`Filters: role=${roleVal}, mirror type=${typeVal}, category=${clsVal}`, 40, 112);

  // KPI line
  const effTxt = totals.eff == null ? "—" : `${totals.eff.toFixed(1)}%`;
  doc.setFont("times","bold");
  doc.text(`Total units: ${totals.units.toLocaleString()}   Target: ${totals.target.toLocaleString()}   Efficiency: ${effTxt}`, 40, 136);

  let y = 160;

  // Breakdown table helper
  function breakdownTable(title, obj){
    const rows = Object.keys(obj).map(k => {
      const u = obj[k].units;
      const t = obj[k].target;
      const e = t > 0 ? (u/t)*100 : null;
      return [k, u.toLocaleString(), t.toLocaleString(), e == null ? "—" : e.toFixed(1) + "%"];
    }).sort((a,b)=> {
      const ea = parseFloat(a[3]) || -999;
      const eb = parseFloat(b[3]) || -999;
      return eb - ea;
    });

   doc.setFont("times","bold");
    doc.setFontSize(12);
    doc.text(title, 40, y);

    doc.autoTable({
      startY: y + 10,
      head: [["Group", "Units", "Target", "Eff %"]],
      body: rows,
      styles: { font:"times", fontSize: 9, cellPadding: 4 },
      headStyles: { fontStyle:"bold" },
      margin: { left: 40, right: 40 }
    });

    y = doc.lastAutoTable.finalY + 18;
  }

  breakdownTable("Breakdown by role", byRole);
  breakdownTable("Breakdown by mirror type", byType);
  breakdownTable("Breakdown by category", byClass);

  // Top / Bottom tables
  function perfTable(title, arr){
    doc.setFont("times","bold");
    doc.setFontSize(12);
    doc.text(title, 40, y);

    const body = (arr || []).map(x => [
      x.name,
      x.units.toLocaleString(),
      x.target.toLocaleString(),
      x.eff == null ? "—" : x.eff.toFixed(1) + "%",
      x.missingStd ? String(x.missingStd) : "0"
    ]);

    doc.autoTable({
      startY: y + 10,
      head: [["Worker / Station", "Units", "Target", "Eff %", "Missing std rows"]],
      body,
      styles: { font:"times", fontSize: 9, cellPadding: 4 },
      headStyles: { fontStyle:"bold" },
      margin: { left: 40, right: 40 }
    });

    y = doc.lastAutoTable.finalY + 18;
  }

  perfTable("Top 5 performers (daily)", top5);
  perfTable("Bottom 5 performers (daily)", bottom5);

  if(missingStdWorkers.length){
    perfTable("Attention: missing standards (top offenders)", missingStdWorkers);
  }

  // Footer timestamp
  doc.setFont("times","normal");
  doc.setFontSize(9);
  doc.text(`Generated: ${nowStamp()}`, 40, 820);

  const filename = `daily_production_report_${to}_baseline_${baselineMode}.pdf`;
  doc.save(filename);
}


  const exportDailyReportBtn = document.getElementById("exportDailyReportBtn");
    if (exportDailyReportBtn) {
    exportDailyReportBtn.addEventListener("click", () => {
        exportDailyProductionReportPdf();
    });
   }   


  const uploaderBtn = $("#openUploaderBtn");
  if (uploaderBtn){
    uploaderBtn.addEventListener("click", () => {
      if (HOURLY_LOG_UPLOADER_URL){
        window.open(HOURLY_LOG_UPLOADER_URL, "_blank");
      } else {
        alert("Uploader URL is not configured yet.");
      }
    });
  }

  const fromInput = $("#fromDate");
  const toInput   = $("#toDate");
  if (fromInput) fromInput.addEventListener("change", loadAndRender);
  if (toInput)   toInput.addEventListener("change", loadAndRender);

  // FILTER DROPDOWNS
  const roleSel   = $("#roleFilter");
  const mtSel     = $("#mirrorTypeFilter");
  const clsSel    = $("#mirrorClassFilter");
  const workerSel = $("#workerFilter");

  if (roleSel){
    roleSel.addEventListener("change", () => {
      populateWorkerFilter(lastRows);
      renderAll(lastRows);
    });
  }
  if (mtSel){
    mtSel.addEventListener("change", () => {
      populateWorkerFilter(lastRows);
      renderAll(lastRows);
    });
  }
  if (clsSel){
    clsSel.addEventListener("change", () => {
      populateWorkerFilter(lastRows);
      renderAll(lastRows);
    });
  }
    if (workerSel){
    workerSel.addEventListener("change", () => renderAll(lastRows));
  }

  // CLICK-TO-DRILL: detail table row -> focus worker + date
  const detailBody = document.getElementById("detailBody");
  if (detailBody) {
    detailBody.addEventListener("click", (e) => {
      const tr = e.target.closest("tr.detail-row-drill");
      if (!tr) return;

      const date = tr.dataset.date;
      const worker = tr.dataset.worker || "all";
      if (!date) return;

      console.log("Drill into", worker, "on", date); // debug line

      // Set date range to that single day
      const fromInput = document.getElementById("fromDate");
      const toInput   = document.getElementById("toDate");
      if (fromInput && toInput) {
        fromInput.value = date;
        toInput.value   = date;
      }

      // Set worker filter to that worker
      const workerSelect = document.getElementById("workerFilter");
      if (workerSelect && worker !== "all") {
        workerSelect.value = worker;
      }

      // Reload data for this worker + date
      loadAndRender();
    });
  }

   // ---------------- DEMO MODE INIT ----------------
  const demoToggle = document.getElementById("demoModeToggle");
  demoMode = localStorage.getItem(DEMO_KEY) === "true";

  if (demoToggle) {
    demoToggle.checked = demoMode;

    demoToggle.addEventListener("change", () => {
        demoMode = !!demoToggle.checked;
        localStorage.setItem(DEMO_KEY, demoMode ? "true" : "false");

        if (demoMode) {
            // stop realtime while in demo mode
            if (rtChannel) {
            try { supabase.removeChannel(rtChannel); } catch(e) {}
            rtChannel = null;
            }
        } else {
            // restart realtime when leaving demo mode
            startRealtime();
        }

        loadAndRender();
    });

  } else {
    console.warn("demoModeToggle not found");
  }

  // ---------------- HOW IT WORKS MODAL ----------------
  const modal    = document.getElementById("howItWorksModal");
  const openBtn  = document.getElementById("howItWorksBtn");
  const closeBtn = document.getElementById("howItWorksCloseBtn");

  if (openBtn && modal) {
    openBtn.addEventListener("click", () => {
      modal.style.display = "flex";
    });
  } else {
    console.warn("HowItWorks elements missing", { openBtn, modal });
  }

  if (closeBtn && modal) {
    closeBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });
  }

  if (modal) {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) modal.style.display = "none";
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") modal.style.display = "none";
    });
  }
 
  // INITIAL LOAD + realtime
  startRealtime();
  loadAndRender();
});

// ---------- DATA FETCH ----------
async function loadAndRender(){
  const from = $("#fromDate").value || null;
  const to   = $("#toDate").value   || null;

  // DEMO MODE: no Supabase calls
  if(demoMode){
    const data = getDemoRows()
      .filter(r => (!from || r.log_date >= from) && (!to || r.log_date <= to))
      .sort((a,b) => (a.log_date > b.log_date ? 1 : -1));

    lastRows = data || [];
    populateWorkerFilter(lastRows);
    renderAll(lastRows);

    // Step 3 check (demo still validates shape)
    console.log("lastRows[0] (demo):", lastRows[0] || null);

    const shape = validateViewShape(lastRows);
    if(!shape.ok){
      console.warn("Demo rows missing fields:", shape.missing);
    }

    // Step 4 freshness
    const latest = lastRows.length ? lastRows[lastRows.length - 1].log_date : "—";
    setFreshness(`Last updated: ${nowStamp()} (Demo) • latest log_date: ${latest}`);
    return;
  }

  let query = supabase
    .from('v_worker_daily_efficiency')
    .select('*')
    .order('log_date', { ascending: true })
    .order('worker_name', { ascending: true });

  if(from) query = query.gte('log_date', from);
  if(to)   query = query.lte('log_date', to);

  const { data, error } = await query;

  if(error){
    console.error("Supabase error:", error.message);
    alert("Error loading worker efficiency data.\nCheck console for details.");
    setFreshness(`Last updated: ${nowStamp()} (Error)`);
    return;
  }

  lastRows = data || [];

  // Step 3: hard-check view output
  console.log("lastRows[0]:", lastRows[0] || null);

  const shape = validateViewShape(lastRows);
  if(!shape.ok){
    console.warn("v_worker_daily_efficiency is missing expected fields:", shape.missing);
    alert(
      "View schema mismatch.\nMissing fields:\n- " + shape.missing.join("\n- ") +
      "\n\nOpen DevTools Console for details."
    );
  }

  populateWorkerFilter(lastRows);
  renderAll(lastRows);

  // Step 4: freshness
  const latest = lastRows.length ? lastRows[lastRows.length - 1].log_date : "—";
  setFreshness(`Last updated: ${nowStamp()} • latest log_date: ${latest}`);
}

// ---------- BASE FILTERS ----------
function applyBaseFilters(rows){
  const role  = ($("#roleFilter").value || "all").toLowerCase();
  const mType = $("#mirrorTypeFilter").value || "all";
  const mCls  = ($("#mirrorClassFilter").value || "all").toLowerCase();

  return (rows || []).filter(r => {
    const roleVal  = (r.role || "").toLowerCase();
    const typeVal  = r.mirror_type || "";
    const classVal = (r.mirror_class || "").toLowerCase();

    if(role !== "all" && roleVal !== role) return false;
    if(mType !== "all" && typeVal !== mType) return false;
    if(mCls  !== "all" && classVal !== mCls) return false;

    return true;
  });
}

// Apply non-zero efficiency toggle
function applyNonZeroFilter(rows){
  return (rows || []).filter(r => {
    const e = getEff(r);
    // keep rows where efficiency is null/blank (standards missing), but hide true 0% rows
    if (e == null) return true;
    return e > 0;
  });
}

// ---------- BASELINE MODE ----------
function getBaselineMode(){
  const el = $("#baselineMode");
  return el ? (el.value || "75") : "75";
}

function getEff(row){
  const mode = getBaselineMode(); // "75" or "100"
  const v = mode === "100"
    ? Number(row.daily_efficiency_pct_100)
    : Number(row.daily_efficiency_pct_75);
  return isNaN(v) ? null : v;
}

function getTarget(row){
  const mode = getBaselineMode();
  const raw = mode === "100" ? row.target_100 : row.target_75;

  // Treat null/blank/0 as missing standard (portfolio-safe + prevents misleading 0 targets)
  if (raw === null || raw === undefined || raw === "" ) return null;

  const v = Number(raw);
  if (isNaN(v) || v <= 0) return null;

  return v;
}

// ---------- WEIGHTED EFFICIENCY HELPERS (Actual ÷ Target) ----------
function safeNum(n){
  const v = Number(n);
  return isNaN(v) ? 0 : v;
}

// sums only rows that have a valid target (engineering standard exists)
function sumActualTarget(rows){
  let actual = 0;
  let target = 0;
  let missingRows = 0;
  let missingUnits = 0;

  (rows || []).forEach(r => {
    const u = safeNum(r.daily_total);
    const t = getTarget(r);

    if (t == null){
      missingRows += 1;
      missingUnits += u;   // units that are missing a standard
      return;
    }

    actual += u;
    target += safeNum(t);
  });

  return { actual, target, missingRows, missingUnits };
}

function weightedEffPct(rows){
  const s = sumActualTarget(rows);
  if (s.target <= 0) return null;
  return (s.actual / s.target) * 100;
}

// build a per-day weighted series (date -> weighted eff)
function buildDailyWeightedSeries(rows){
  const byDay = {};
  (rows || []).forEach(r => {
    const d = (r.log_date || "").slice(0,10);
    if (!d) return;
    if (!byDay[d]) byDay[d] = [];
    byDay[d].push(r);
  });

  const dates = Object.keys(byDay).sort();
  const series = dates.map(date => {
    const dayRows = byDay[date];
    return {
      date,
      eff: weightedEffPct(dayRows),
      actual: sumActualTarget(dayRows).actual,
      target: sumActualTarget(dayRows).target
    };
  });

  return series;
}

// ---------- FILTER: WORKER / STATION DROPDOWN ----------
function populateWorkerFilter(rows){
  const sel = $("#workerFilter");
  if(!sel) return;

  const prev = sel.value || "all";
  const base = applyBaseFilters(rows || []);
  const workers = uniq(base.map(r => r.worker_name || "Unknown")).sort();

  sel.innerHTML = '<option value="all">All</option>';
  workers.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });

  if(prev !== "all" && workers.includes(prev)){
    sel.value = prev;
  } else if(workers.length === 1){
    sel.value = workers[0];
  } else {
    sel.value = "all";
  }
}

// ---------- CLICK FROM BAR → SELECT WORKER ----------
function selectWorkerFromChart(workerName){
  if (!workerName) return;

  const sel = $("#workerFilter");
  if (!sel) return;

  const optionValues = Array.from(sel.options).map(o => o.value);
  if (optionValues.includes(workerName)){
    sel.value = workerName;
  } else {
    sel.value = "all";
  }

  renderAll(lastRows);
}

// ---------- RENDER PIPELINE ----------
function renderAll(rows){
  const base0 = applyBaseFilters(rows || []);
  const base  = applyNonZeroFilter(base0);

  const workerFilter = $("#workerFilter").value;
  let workerFiltered = base;

  if(workerFilter && workerFilter !== "all"){
    workerFiltered = base.filter(r => (r.worker_name || "") === workerFilter);
  }

  renderSummary(base);
  renderWorkerBarChart(base);
  renderWorkerTrendChart(workerFiltered, workerFilter);
  renderWeeklyLeaderboard(base);
  renderTable(workerFiltered.length ? workerFiltered : base);

  if (workerFilter && workerFilter !== "all" && workerFiltered.length) {
    // dept-level rows = same filters, all workers (base)
    const deptRows = base;
    const stats = computeWorkerSnapshotStats(workerFiltered, deptRows);
    updateWorkerSnapshot(workerFilter, stats);
  } else {
    updateWorkerSnapshot(null, null);
  }
}

    // ---------- SUMMARY ----------
    function renderSummary(rows){
    const box = $("#summaryCards");
    if(!box) return;

    if(!rows || !rows.length){
        box.innerHTML = `
        <div class="summary-card">
            <div class="summary-label">No data</div>
            <div class="summary-value">0%</div>
            <div class="summary-sub">No records for this filter.</div>
        </div>`;
        return;
    }

    // Department-level weighted efficiency (Actual ÷ Target)
    const deptSum = sumActualTarget(rows);
    const deptEff = deptSum.target > 0 ? (deptSum.actual / deptSum.target) * 100 : null;

    // Worker-level weighted efficiency (per worker: SUM(actual)/SUM(target))
    const byWorker = {};
    rows.forEach(r => {
        const name = r.worker_name || "Unknown";
        if (!byWorker[name]) byWorker[name] = [];
        byWorker[name].push(r);
    });

    let bestName  = "—";
    let bestEff   = null;
    let bestUnits = 0;

    let worstName  = "—";
    let worstEff   = null;
    let worstUnits = 0;

    Object.keys(byWorker).forEach(name => {
        const arr = byWorker[name];
        const s = sumActualTarget(arr);
        if (s.target <= 0) return; // skip if no standards

        const e = (s.actual / s.target) * 100;

        if (bestEff === null || e > bestEff){
        bestEff = e;
        bestName = name;
        bestUnits = s.actual;
        }

        if (worstEff === null || e < worstEff){
        worstEff = e;
        worstName = name;
        worstUnits = s.actual;
        }
    });

    const deptEffTxt  = deptEff == null ? "—" : deptEff.toFixed(1) + "%";
    const bestEffTxt  = bestEff == null ? "—" : bestEff.toFixed(1) + "%";
    const worstEffTxt = worstEff == null ? "—" : worstEff.toFixed(1) + "%";

    const missingNote =
        deptSum.missingRows > 0
        ? ` • Missing standards: ${deptSum.missingRows} rows (${deptSum.missingUnits.toLocaleString()} units)`
        : "";

    box.innerHTML = `
        <div class="summary-card">
        <div class="summary-label">Overall efficiency (Actual ÷ Target)</div>
        <div class="summary-value">${deptEffTxt}</div>
        <div class="summary-sub">
            ${deptSum.actual.toLocaleString()} actual vs ${deptSum.target.toLocaleString()} target${missingNote}
        </div>
        </div>

        <div class="summary-card">
        <div class="summary-label">Best performer (weighted)</div>
        <div class="summary-value">${bestName}</div>
        <div class="summary-sub">${bestEffTxt} • ${bestUnits.toLocaleString()} units</div>
        </div>

        <div class="summary-card">
        <div class="summary-label">Lowest performer (weighted)</div>
        <div class="summary-value">${worstName}</div>
        <div class="summary-sub">${worstEffTxt} • ${worstUnits.toLocaleString()} units</div>
        </div>
    `;
    }


// ---------- CHART THEME HELPERS ----------
function chartTextColor(){
  const theme = document.documentElement.getAttribute("data-theme");
  return theme === "dark" ? "#ffffff" : "#111111";
}

// ---------- EFFICIENCY THRESHOLDS ----------
let EFF_GOOD_MIN = 90;
let EFF_WARN_MIN = 75;

function getEfficiencyBand(value){
  const v = Number(value);
  if (isNaN(v)) return null;

  if (v >= EFF_GOOD_MIN) return "good";
  if (v >= EFF_WARN_MIN) return "warn";
  return "bad";
}

function applyEfficiencyClassToElement(el, value){
  if (!el) return;
  el.classList.remove("eff-good", "eff-warn", "eff-bad");
  const band = getEfficiencyBand(value);
  if (!band) return;
  el.classList.add("eff-" + band);
}

function getEfficiencyColor(value){
  const band = getEfficiencyBand(value);
  switch (band){
    case "good": return "#2ecc71";
    case "warn": return "#ffd84d";
    case "bad":  return "#ff6b6b";
    default:     return "#4b5563";
  }
}

// ---------- BAR CHART ----------
function renderWorkerBarChart(rows){
  const ctx   = $("#workerBarChart");
  const title = $("#barTitle");
  if(!ctx) return;

  if(!rows || !rows.length){
    if(barChartInstance){
      barChartInstance.destroy();
      barChartInstance = null;
    }
    if(title){
      title.textContent = "Average efficiency by worker / station (no data)";
    }
    return;
  }

  const byWorker = {};
  rows.forEach(r => {
    const name = r.worker_name || "Unknown";
    const e = getEff(r);
    if (e == null || isNaN(e)) return;

    if (!byWorker[name]){
      byWorker[name] = {
        rows: [],
        effs: [],
        totalUnitsAll: 0
      };
    }
    byWorker[name].rows.push(r);
    byWorker[name].effs.push(e);
    byWorker[name].totalUnitsAll += Number(r.daily_total) || 0;
  });

  const labels   = Object.keys(byWorker).sort();
  const dataVals = [];
  const workerDetails = [];

  labels.forEach(name => {
    const info = byWorker[name];

    // Daily avg (weighted) = most recent day only (SUM actual ÷ SUM target)
    let dailyAvg = NaN;
    if (info.rows.length){
    const latestDate = [...info.rows]
        .map(r => (r.log_date || "").slice(0,10))
        .filter(Boolean)
        .sort()
        .pop();

    const latestDayRows = info.rows.filter(r => (r.log_date || "").slice(0,10) === latestDate);
    const e = weightedEffPct(latestDayRows);
    if (e != null && !isNaN(e)) dailyAvg = e;
    }

    const dailyAvgRounded = Math.round(dailyAvg * 10) / 10;
    dataVals.push(dailyAvgRounded);

    // Weekly stats (latest week only)
    const rowsSorted = [...info.rows].sort((a,b) =>
    (a.log_date > b.log_date) ? 1 : (a.log_date < b.log_date ? -1 : 0)
    );

    const weekKeys = uniq(
    rowsSorted
        .map(r => getWeekKey(r.log_date || r.day || ""))
        .filter(k => !!k)
    ).sort();

    let weeklyAvg = null;
    let weeklyUnits = 0;

    if (weekKeys.length){
    const latestWeek = weekKeys[weekKeys.length - 1];
    const latestWeekRows = rowsSorted.filter(r =>
        getWeekKey(r.log_date || r.day || "") === latestWeek
    );

    // ✅ Weekly avg (weighted) = SUM actual ÷ SUM target for latest week
    weeklyAvg = weightedEffPct(latestWeekRows);

    weeklyUnits = latestWeekRows.reduce(
        (t,r) => t + (Number(r.daily_total) || 0),
        0
    );
    }


    if (weeklyAvg === null) weeklyAvg = dailyAvg;
    if (!weeklyUnits) weeklyUnits = 0;

    // Trend label (no pts/week)
    let trendLabel = "Trend: —";
    if (rowsSorted.length >= 2){
      const series = rowsSorted.map(r => ({
        date: r.log_date,
        eff: getEff(r)
      })).filter(p => p.eff != null && !isNaN(p.eff));

      if (series.length >= 2){
        const n = series.length;
        const split = Math.floor(n / 2) || 1;

        const early = series.slice(0, split);
        const late  = series.slice(n - split);

        const earlyAvg = early.reduce((t,p) => t + p.eff, 0) / early.length;
        const lateAvg  = late.reduce((t,p) => t + p.eff, 0) / late.length;

        const diff = lateAvg - earlyAvg;
        const absDiff = Math.abs(diff);

        let descriptor = "stable";
        if (absDiff < 3){
          descriptor = "stable";
        } else if (absDiff < 7){
          descriptor = diff > 0 ? "slightly upward" : "slightly downward";
        } else {
          descriptor = diff > 0 ? "significantly upward" : "significantly downward";
        }

        if (descriptor === "stable"){
          trendLabel = "Trend: stable";
        } else {
          trendLabel = `Trend: ${descriptor}`;
        }
      }
    }

    workerDetails.push({
      name,
      dailyAvg: dailyAvgRounded,
      weeklyAvg: weeklyAvg,
      weeklyUnits: weeklyUnits,
      trendLabel: trendLabel
    });
  });

  if(title){
    title.textContent = "Average efficiency by worker / station (selected filters)";
  }

  const colors = dataVals.map(v => getEfficiencyColor(v));

  const data = {
    labels,
    datasets:[{
      label:"Avg efficiency (%)",
      data:dataVals,
      backgroundColor: colors,
      borderColor: colors,
      borderWidth: 1
    }]
  };

  const options = {
    responsive:true,
    maintainAspectRatio:false,
    scales:{
      x: {
        ticks: {
          color: chartTextColor(),
          maxRotation: 0,
          minRotation: 0,
          autoSkip: false
        }
      },
      y:{
        beginAtZero:true,
        max:120,
        ticks: {
          color: chartTextColor()
        }
      }
    },
    plugins:{
      legend:{ display:false },
      tooltip: {
        backgroundColor: "#111827",
        borderColor: "#111827",
        borderWidth: 1,
        titleColor: "#f9fafb",
        bodyColor: "#f9fafb",

        callbacks: {
          title: (items) => {
            if (!items.length) return "";
            const idx = items[0].dataIndex;
            return workerDetails[idx]?.name || "";
          },
          label: (item) => {
            const idx = item.dataIndex;
            const w   = workerDetails[idx];
            if (!w) return "";
            return `Daily avg: ${w.dailyAvg.toFixed(1)}%`;
          },
          afterBody: (items) => {
            if (!items.length) return [];
            const idx = items[0].dataIndex;
            const w   = workerDetails[idx];
            if (!w) return [];

            const lines = [];
            lines.push(`Weekly avg: ${w.weeklyAvg == null ? "—" : w.weeklyAvg.toFixed(1) + "%"}`);
            lines.push(`Weekly total units: ${w.weeklyUnits.toLocaleString()}`);
            lines.push(w.trendLabel);

            return lines;
          }
        }
      }
    },
    onClick: (evt, elements) => {
      if (!elements || !elements.length) return;
      const first = elements[0];
      const index = first.index;
      const workerName = labels[index];
      selectWorkerFromChart(workerName);
    }
  };

  if(barChartInstance){
    barChartInstance.data    = data;
    barChartInstance.options = options;
    barChartInstance.update();
  }else{
    barChartInstance = new Chart(ctx, {
      type:'bar',
      data,
      options
    });
  }
}

    // ---------- LINE CHART ----------
    function renderWorkerTrendChart(rows, workerFilter){
    const ctx   = $("#workerTrendChart");
    const title = $("#trendTitle");
    if(!ctx) return;

    if(!rows || !rows.length || !workerFilter || workerFilter === "all"){
        if(trendChartInstance){
        trendChartInstance.destroy();
        trendChartInstance = null;
        }
        if(title){
        title.textContent = "Daily efficiency trend (select a worker / station)";
        }
        return;
    }

    // ✅ Day-by-day weighted series (SUM actual ÷ SUM target)
    const series = buildDailyWeightedSeries(rows)
        .filter(p => p.eff != null && !isNaN(p.eff));

    if(!series.length){
        if(trendChartInstance){
        trendChartInstance.destroy();
        trendChartInstance = null;
        }
        if(title){
        title.textContent = `Daily efficiency trend — ${workerFilter} (no standards)`;
        }
        return;
    }

    const labels = series.map(p => p.date);
    const effs   = series.map(p => p.eff);

    if(title){
        title.textContent = `Daily efficiency trend — ${workerFilter}`;
    }

    const avgEff = effs.reduce((t,v)=> t + v, 0) / effs.length;
    const lineColor = getEfficiencyColor(avgEff);

    const data = {
        labels,
        datasets:[{
        label:"Efficiency (%)",
        data:effs,
        tension:0.3,
        borderColor: lineColor,
        backgroundColor: lineColor,
        pointBackgroundColor: lineColor,
        pointBorderColor: lineColor
        }]
    };

    const options = {
        responsive:true,
        maintainAspectRatio:false,
        scales:{
        x: { ticks: { color: chartTextColor() } },
        y: { beginAtZero:true, max:120, ticks: { color: chartTextColor() } }
        },
        plugins:{
        legend:{ display:false },
        tooltip: {
            backgroundColor: "#111827",
            borderColor: "#111827",
            borderWidth: 1,
            titleColor: "#f9fafb",
            bodyColor: "#f9fafb",
        }
        }
    };

    if(trendChartInstance){
        trendChartInstance.data    = data;
        trendChartInstance.options = options;
        trendChartInstance.update();
    }else{
        trendChartInstance = new Chart(ctx, { type:'line', data, options });
    }
    }

    // ---------- WEEKLY LEADERBOARD ----------
    function renderWeeklyLeaderboard(rows){
    const tbody = $("#leaderBody");
    const title = $("#leaderTitle");
    if(!tbody) return;

    if(!rows || !rows.length){
        tbody.innerHTML =
        '<tr><td colspan="5" style="text-align:center;padding:8px;">No data for this filter.</td></tr>';
        if(title) title.textContent = "Weekly leaderboard (latest week in range)";
        return;
    }

    // group by week + worker, but compute WEIGHTED eff using sums
    const groups = {};
    rows.forEach(r => {
        const dateStr = r.log_date || r.day || "";
        const weekKey = getWeekKey(dateStr);
        if(!weekKey) return;

        const name = r.worker_name || "Unknown";
        const gKey = weekKey + "||" + name;

        if(!groups[gKey]) groups[gKey] = { week: weekKey, name, rows: [] };
        groups[gKey].rows.push(r);
    });

    const arr = Object.values(groups).map(g => {
        const s = sumActualTarget(g.rows);
        const avg = s.target > 0 ? (s.actual / s.target) * 100 : null;

        // days counted = unique days that had a standard
        const daySet = new Set();
        g.rows.forEach(r => {
        if (getTarget(r) == null) return;
        daySet.add((r.log_date || "").slice(0,10));
        });

        return {
        week: g.week,
        name: g.name,
        avg,
        days: daySet.size
        };
    }).filter(x => x.avg != null);

    if(!arr.length){
        tbody.innerHTML =
        '<tr><td colspan="5" style="text-align:center;padding:8px;">No efficiency data for leaderboard.</td></tr>';
        if(title) title.textContent = "Weekly leaderboard (latest week in range)";
        return;
    }

    let latestWeek = null;
    arr.forEach(g => { if(!latestWeek || g.week > latestWeek) latestWeek = g.week; });

    const latestRows = arr.filter(g => g.week === latestWeek).sort((a,b) => b.avg - a.avg);
    const top = latestRows.slice(0,5);

    if(title) title.textContent = `Weekly leaderboard — ${latestWeek}`;

    let html = "";
    top.forEach((g, idx) => {
        html += `
        <tr>
            <td>${idx+1}</td>
            <td>${g.week}</td>
            <td>${g.name.replace(/</g,"&lt;")}</td>
            <td style="text-align:right;">${g.avg.toFixed(1)}</td>
            <td style="text-align:right;">${g.days}</td>
        </tr>
        `;
    });

    tbody.innerHTML = html || '<tr><td colspan="5" style="text-align:center;padding:8px;">No leaderboard rows.</td></tr>';
    }

// ---------- HELPER: GET CURRENT FILTERED ROWS (MATCHES DETAIL TABLE) ----------
function getCurrentFilteredRows() {
  const worker = $("#workerFilter").value || "all";

  const base0 = applyBaseFilters(lastRows || []);
  const base = applyNonZeroFilter(base0);

  let data = base;
  if (worker !== "all") {
    data = base.filter(r => (r.worker_name || "") === worker);
  }

  return { worker, rows: data };
}

// ---------- CSV EXPORT ----------
function exportRowsToCSV(rows) {
  if (!rows || !rows.length) {
    alert("No data available to export.");
    return;
  }

  const headers = [
    "Date",
    "Role",
    "Worker / Station",
    "Mirror type",
    "Category",
    "Daily total",
    "Target",
    "Efficiency % (adjusted)"
  ];

  const csvRows = [];
  csvRows.push(headers.join(",")); // header row

  rows.forEach(r => {
    const eff = getEff(r);
    const row = [
      r.log_date || "",
      r.role || "",
      r.worker_name || "",
      r.mirror_type || "",
      r.mirror_class || "",
      Number(r.daily_total) || 0,
      getTarget(r),
      isNaN(eff) ? "" : eff.toFixed(2)
    ];
    // escape quotes, wrap each cell
    csvRows.push(row.map(v => `"${String(v).replace(/"/g, '""')}"`).join(","));
  });

  const csvContent = csvRows.join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

  const from = $("#fromDate").value || "start";
  const to = $("#toDate").value || "end";

  const workerSelect = $("#workerFilter").value || "all";
  const workerLabel =
    workerSelect === "all"
      ? "ALL_WORKERS"
      : workerSelect.replace(/\s+/g, "_");

  const filename = `efficiency_export_${workerLabel}_${from}_to_${to}.csv`;

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  URL.revokeObjectURL(link.href);
}

// ---------- PDF EXPORT (1:1 COACHING) ----------
async function exportWorkerPdf() {
  const { worker, rows } = getCurrentFilteredRows();

  if (!rows.length) {
    alert("No data available to export.");
    return;
  }

  if (!worker || worker === "all") {
    alert("PDF export is designed for 1:1s.\nPlease select a single worker / station first.");
    return;
  }

  // Compute snapshot stats for header (reuse existing function)
  const base0 = applyBaseFilters(lastRows || []);
  const base = applyNonZeroFilter(base0);
  const deptRows = base; // same filters, all workers

  const stats = computeWorkerSnapshotStats(rows, deptRows);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

  const from = $("#fromDate").value || "start";
  const to = $("#toDate").value || "end";
  const baselineMode = getBaselineMode(); // "75" or "100"

  // ---------- HEADER ----------
  doc.setFont("Times", "Bold");
  doc.setFontSize(16);
  doc.text("Worker Efficiency 1:1 Report", 40, 40);

  doc.setFont("Times", "Normal");
  doc.setFontSize(11);
  doc.text(`Worker / Station: ${worker}`, 40, 65);
  doc.text(`Date range: ${from} to ${to}`, 40, 80);
  doc.text(
    `Baseline: ${baselineMode === "100" ? "100% engineering standard" : "75% engineering standard"}`,
    40,
    95
  );

  // Snapshot quick stats
  let y = 120;
  if (stats) {
    doc.text(
      `Range avg efficiency: ${stats.weeklyAverageEfficiency != null ? stats.weeklyAverageEfficiency.toFixed(1) + "%" : "—"}`,
      40,
      y
    ); y += 15;

    doc.text(
      `Total units (range): ${stats.weeklyTotalUnits != null ? stats.weeklyTotalUnits.toLocaleString() : "—"}`,
      40,
      y
    ); y += 15;

    doc.text(
      `Consistency: ${stats.consistencyLabel || "—"}${stats.consistencyStd != null ? ` (Std dev: ${stats.consistencyStd.toFixed(1)} pts)` : ""}`,
      40,
      y
    ); y += 15;

    if (stats.onTargetPct != null) {
      doc.text(
        `On-target days (≥ ${EFF_WARN_MIN}%): ${stats.onTargetDays} of ${stats.daysCount} days (${stats.onTargetPct.toFixed(0)}%)`,
        40,
        y
      ); y += 15;
    }

    if (stats.topType) {
      doc.text(
        `Top mirror type: ${stats.topType} — ${stats.topTypeUnits.toLocaleString()} units (${stats.topTypeShare != null ? stats.topTypeShare.toFixed(0) + "%" : "—"})`,
        40,
        y
      ); y += 15;
    }

    if (stats.topClass) {
      doc.text(
        `Top mirror category: ${stats.topClass} — ${stats.topClassUnits.toLocaleString()} units (${stats.topClassShare != null ? stats.topClassShare.toFixed(0) + "%" : "—"})`,
        40,
        y
      ); y += 15;
    }

    if (stats.trendLabel && stats.trendLabel !== "Trend: —") {
      doc.text(stats.trendLabel, 40, y);
      y += 20;
    } else {
      y += 10;
    }
  } else {
    y += 10;
  }

  // ---------- DETAIL TABLE ----------
  const tableHead = [[
    "Date",
    "Role",
    "Mirror type",
    "Category",
    "Daily total",
    "Target",
    "Eff %"
  ]];

  const tableBody = rows.map(r => {
    const eff = getEff(r);
    const tgt = getTarget(r);
    return [
        r.log_date || "",
        r.role || "",
        r.mirror_type || "",
        r.mirror_class || "",
        (Number(r.daily_total) || 0).toLocaleString(),
        (tgt == null ? "—" : tgt.toLocaleString()),
        (eff == null || isNaN(eff)) ? "—" : eff.toFixed(1)
    ];
  });


  doc.autoTable({
    startY: y + 5,
    head: tableHead,
    body: tableBody,
    styles: {
      font: "Times",
      fontSize: 9,
      cellPadding: 4
    },
    headStyles: {
      fontStyle: "bold"
    }
  });

  const filename = `worker_1on1_${worker.replace(/\s+/g, "_")}_${from}_to_${to}.pdf`;
  doc.save(filename);
}

// ---------- DETAIL TABLE ----------
function renderTable(rows){
  const tbody = $("#detailBody");
  if(!tbody) return;

  if(!rows || !rows.length){
    tbody.innerHTML =
      '<tr><td colspan="9" style="text-align:center;padding:10px;">No rows for this filter.</td></tr>';
    return;
  }

  let html = "";
  rows.forEach(r => {
    const eff = getEff(r);
    const band = getEfficiencyBand(eff);
    const effClass = band ? `eff-${band}` : "";
    const target = getTarget(r);
    const effDisplay = (eff == null || isNaN(eff)) ? '—' : eff.toFixed(2);
    const targetDisplay = (target == null) ? '— (missing standard)' : target.toLocaleString();


    html += `
      <tr
        class="detail-row-drill"
        data-date="${r.log_date || ''}"
        data-worker="${(r.worker_name || '').replace(/"/g,'&quot;')}"
        style="cursor:pointer;"
      >
        <td>${r.log_date || '-'}</td>
        <td>${(r.role || '').replace(/</g,"&lt;")}</td>
        <td>${(r.worker_name || '').replace(/</g,"&lt;")}</td>
        <td>${(r.part_number || '').replace(/</g,"&lt;")}</td> <!-- NEW -->
        <td>${(r.mirror_type || '').replace(/</g,"&lt;")}</td>
        <td>${(r.mirror_class || '').replace(/</g,"&lt;")}</td>
        <td style="text-align:right;">${(Number(r.daily_total)||0).toLocaleString()}</td>
        <td style="text-align:right;">${targetDisplay}</td>
        <td style="text-align:right;" class="${effClass}">${effDisplay}</td>
      </tr>
    `;
  });
    tbody.innerHTML = html;
}
</script>

<!-- HOW IT WORKS MODAL -->
<div id="howItWorksModal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; background:rgba(0,0,0,.45); z-index:9999;">
  <div style="width:min(760px, 100%); background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:14px 16px; box-shadow:0 10px 30px rgba(0,0,0,.18);">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div class="section-title" style="margin:0;">How it works</div>
      <button class="btn" id="howItWorksCloseBtn" type="button">Close</button>
    </div>

    <div style="font-size:13px; color:var(--text); line-height:1.45; margin-top:10px;">
      This dashboard reads daily worker output from a single dataset and calculates efficiency against an engineering baseline (75% or 100%).
      Filters (date range, role, mirror type, category, worker) update all views: summary cards, worker ranking bar chart,
      individual trend line, weekly leaderboard, and the detail table. Selecting a worker enables the Worker Snapshot panel and 1:1 PDF export.
      Demo mode loads safe sample data in-browser for portfolio use without connecting to any backend.
    </div>

    <div style="margin-top:10px; font-size:12px; color:var(--muted);">
      Tip: Demo mode is ideal for screenshots and recruiter walkthroughs.
    </div>
  </div>
</div>

</body>
</html>
